\abschnitt{termination}

There are a few different ways to terminate a given fiber without
terminating the whole process, or engaging undefined behavior.\\

When a \fiber instance is constructed with an \entryfn, its new stack is
initialized with the frame of an implicit top-level function that can
catch \unwindex. \unwindex binds a \fiber instance; the implicit \cpp{catch}
clause returns the bound \fiber from that top-level function.\\

Therefore, any of the following will gracefully terminate a fiber:

\begin{itemize}
    \item Cause its \entryfn to return a valid \fiber.
    \item From within the fiber you wish to terminate, call \unwindfib with a
          valid \fiber. This throws a \unwindex instance that binds the passed
          \fiber; that fiber will be resumed when the active fiber terminates.
    \item From within the fiber you wish to terminate, construct and
          throw \unwindex, binding the \fiber you intend to resume next. This
          is what \unwindfib does internally.
    \item Call \cpp{fiber\_context::resume\_with(unwind\_fiber)}. This is what \dtor
          does. Since \unwindfib accepts a \fiber, and since \resumewith
          synthesizes a \fiber representing its caller and passes it to the
          subject function, this terminates the fiber referenced by the
          original \fiber instance and switches back to the caller.
    \item Engage \dtor: switch to some other fiber, which will
          receive a \fiber instance representing the current fiber. Make that
          other fiber destroy the received \fiber instance.
\end{itemize}

(However, since the operating system allocates the stack for \main and for a
thread's \entryfn, of course there is no implicit top-level stack frame, no
implicit \cpp{catch (std::unwind\_exception)}. In a conforming implementation,
returning from a thread's \entryfn\xspace may terminate all fibers on that
thread. Returning from \main may terminate the whole process.)\\

In an environment that forbids exceptions, every \fiber you launch must
terminate gracefully, by returning from its top-level function. You may not
call \unwindfib. You may not call \dtor, explicitly or implicitly, on a
valid \fiber instance.\\

When an explicitly-launched fiber's \entryfn\xspace returns a valid \fiber
instance, that fiber is terminated. Control switches to the fiber indicated by
the returned \fiber instance.\\

Returning an invalid \fiber instance (\opbool returns \cpp{false}) invokes
undefined behavior.\\

If the \entryfn\xspace returns the same \fiber instance it was originally
passed (or rather, the \fiber instance most recently returned by \resume,
\resumewith, \xtresume or \xtresumewith), control returns to the fiber that
most recently resumed the running fiber. However, the \entryfn\xspace may
return (switch to) any reachable valid \fiber instance.\\

\emph{Calling} \resume means: ``Please switch to the indicated fiber; I
am suspending; please resume me later.''\\

\emph{Returning} a particular \fiber means: ``Please switch to the indicated
fiber; and by the way, I am done.''
